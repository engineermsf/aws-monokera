# Deploy automático de la Lambda de extracción (21_extraccion)
# Se ejecuta al hacer push a feature/develop (o manual con workflow_dispatch)
name: Deploy Lambda extracción

on:
  push:
    branches: [feature/develop]
    paths:
      - "parte2/21_extraccion/**"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build package
        run: |
          BUILD_DIR=$(mktemp -d)
          cp -r parte2/21_extraccion/extraction "$BUILD_DIR/"
          cp parte2/21_extraccion/lambda/handler.py "$BUILD_DIR/"
          pip install -r parte2/21_extraccion/lambda/requirements.txt -t "$BUILD_DIR/" --quiet
          cd "$BUILD_DIR" && zip -r lambda.zip . -x "*.pyc" -x "__pycache__/*" -x "*__pycache__*"
          mv "$BUILD_DIR/lambda.zip" "$GITHUB_WORKSPACE/lambda.zip"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
        # Alternativa con access key: usar aws-access-key-id y aws-secret-access-key en secrets

      - name: Update Lambda configuration
        run: |
          aws lambda update-function-configuration \
            --function-name ${{ secrets.LAMBDA_EXTRACCION_NAME }} \
            --environment "Variables={BRONZE_OUTPUT_PATH=s3://bnc-lkh-dev-bronze/spaceflight,EXTRACCION_MAX_ITEMS=1}"

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ secrets.LAMBDA_EXTRACCION_NAME }} \
            --zip-file fileb://lambda.zip
