# Deploy automático de la Lambda de extracción (21_extraccion)
# Se ejecuta al hacer push a feature/develop (o manual con workflow_dispatch)
name: Deploy Lambda extracción

on:
  push:
    branches: [feature/develop]
    paths:
      - "parte2/21_extraccion/**"
      - ".github/workflows/deploy-extraccion.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      # Zip solo código; las deps (pyarrow, requests) vienen de la layer (variable LAYER_ARN).
      - name: Build package
        run: |
          BUILD_DIR=$(mktemp -d)
          cp -r parte2/21_extraccion/extraction "$BUILD_DIR/"
          cp parte2/21_extraccion/lambda/handler.py "$BUILD_DIR/"
          (cd "$BUILD_DIR" && zip -r lambda.zip . -x "*.pyc" -x "__pycache__/*" -x "*__pycache__*")
          cp "$BUILD_DIR/lambda.zip" "$GITHUB_WORKSPACE/lambda.zip"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
        # Alternativa con access key: usar aws-access-key-id y aws-secret-access-key en secrets

      # Primero subir código ligero; luego config+layer (código+layer no pueden superar 250 MB).
      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ secrets.LAMBDA_EXTRACCION_NAME }} \
            --zip-file fileb://lambda.zip

      - name: Update Lambda configuration
        env:
          LAYER_ARN: ${{ secrets.LAYER_ARN || vars.LAYER_ARN }}
        run: |
          if [ -z "$LAYER_ARN" ]; then
            echo "::error::LAYER_ARN vacío. Crea un secret o variable en Settings -> Secrets and variables -> Actions, nombre exacto: LAYER_ARN"
            exit 1
          fi
          aws lambda update-function-configuration \
            --function-name ${{ secrets.LAMBDA_EXTRACCION_NAME }} \
            --environment "Variables={BRONZE_OUTPUT_PATH=s3://bnc-lkh-dev-bronze/spaceflight,EXTRACCION_MAX_ITEMS=1}" \
            --layers "$LAYER_ARN"
